<html>
  <head>
    <meta charset="utf-8" />
    <link
      rel="stylesheet"
      data-name="vs/editor/editor.main"
      href="node_modules/monaco-editor/min/vs/editor/editor.main.css"
    />
    <link rel="stylesheet" href="styles.css" />

    <script src="buffer.js"></script>
    <script>
      window.sourceEditor;
      window.activeReports = {};
      window.watchedBytes = {};

      window.start = Date.now();

      window.previousReports = {};

      // from https://gist.github.com/bgrins/5108712
      window.reports = {};

      if (navigator.userAgent.indexOf("BetterTouchTool") === -1) {
        setInterval(() => {
          newReport(
            "uuid",
            getRandomInt(0, 5),
            `0001020300001020300001020300001020300001020300001020300${getRandomInt(
              0,
              3
            )}`
          );
        }, 500);
        setTimeout(() => {
          "uuid",
            newReport(
              getRandomInt(0, 5),
              `0001020300001020300001020300001020300001020300001020300${getRandomInt(
                0,
                3
              )}`
            );
        }, 10);
      }

      function saveChanges() {
        callBTT("save_changes");
      }

      function resetChanges() {
        loadSavedData(window.originalSaved);
      }

      function loadSavedData(savedData) {
        if (savedData["BTTGenericDeviceActiveReports"]) {
          window.activeReports = savedData["BTTGenericDeviceActiveReports"];
        }

        if (savedData["BTTGenericDeviceWatchedBytes"]) {
          window.watchedBytes = savedData["BTTGenericDeviceWatchedBytes"];
        }
        if (savedData["BTTGenericDeviceScript"]) {
          window.script = savedData["BTTGenericDeviceScript"];
        }
        if (window.sourceEditor) {
          window.sourceEditor.setValue(window.script);
        }

        window.originalSaved = savedData;
        return savedData;
      }

      function save() {
        const script = window.sourceEditor.getValue();
        const enabledReports = window.activeReports;
        const watchedBytes = window.watchedBytes;

        let saveObj = {
          BTTGenericDeviceScript: script,
          BTTGenericDeviceActiveReports: enabledReports,
          BTTGenericDeviceWatchedBytes: watchedBytes,
        };

        return saveObj;
      }

      const hex = (d) => Number(d).toString(16).padStart(2, "0");

      function log(message) {
        console.log(message);
        if (document.getElementById("scriptOutput") !== undefined) {
          let span = document.createElement("span");
          span.innerText =
            (Date.now() - window.start) / 1000 + "s : " + message;
          document.getElementById("scriptOutput").appendChild(span);
        }
      }

      function removeAllChildrenForElement(element) {
        var range = document.createRange();
        range.selectNodeContents(element);
        range.deleteContents();
      }

      function bttTriggerDeviceTrigger(trigger) {
        console.log("triggering", trigger);
      }

      function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      function updateByteIndexes(size) {
        const legend = document.getElementById("analyzer-legend");
        if (legend.childElementCount < size) {
          removeAllChildrenForElement(legend);
          for (let i = 0; i < size; i++) {
            const index = document.createElement("span");
            index.className = "byte-index";
            index.innerText = i;
            legend.appendChild(index);
          }
        }
      }

      function bttGetNextEvenWithoutChange(targetDevice, reportID) {
        console.info("delete repordID", reportID);
        const reportHTMLID = "report" + reportID;
        delete window.previousReports[reportHTMLID];
      }

      function newReport(uuid, reportID, report) {
        if (window.activeReports[reportID] === undefined) {
          window.activeReports[reportID] = true;
          window.watchedBytes[reportID] = [];
        }
        const reportHTMLID = "report" + reportID;

        let previousReportBuffer = window.previousReports[reportHTMLID]
          ? buffer.Buffer.from(window.previousReports[reportHTMLID], "hex")
          : undefined;
        let reportBuffer = buffer.Buffer.from(report, "hex");

        let changed = false;
        let nothingChanged = false;
        if (window.activeReports[reportID] === true) {
          if (
            previousReportBuffer === undefined ||
            previousReportBuffer.length === 0
          ) {
            changed = true;
          } else {
            for (let byteIndex of window.watchedBytes[reportID]) {
              if (
                reportBuffer.readUInt8(byteIndex) !=
                previousReportBuffer.readUInt8(byteIndex)
              ) {
                changed = true;
                break;
              }
            }
          }
          if (
            changed === true ||
            window.previousReports[reportHTMLID] !== report
          ) {
            addReportToUI(
              reportID,
              report,
              previousReportBuffer,
              reportBuffer,
              changed
            );
          }
          window.previousReports = Object.assign({}, window.reports);
          window.previousReports[reportHTMLID] = report;
          if (changed === true) {
            try {
              analyzeDeviceInput(uuid, reportID, report);
            } catch (error) {}
          }
        
          window.reports[reportHTMLID] = report;
        }
      }

      // write a function that lists fibonacci numbers
     


      function addReportToUI(
        reportID,
        report,
        previousReportBuffer,
        reportBuffer,
        changed
      ) {
        const containerX = document.getElementById(
          "analyzer-content-container"
        );
        containerX.className = "analyzer-visible";

        const reportHTMLID = "report" + reportID;

        let reportContainer = document.getElementById(reportHTMLID);
        if (!reportContainer) {
          reportContainer = document.createElement("div");
          reportContainer.id = reportHTMLID;
          reportContainer.className = "report-container";
          document.getElementById("analyzer").appendChild(reportContainer);
        }

        removeAllChildrenForElement(reportContainer);

        const headingID = "report-heading-" + reportID;

        let reportHeading = document.getElementById(headingID);

        if (!reportHeading) {
          reportHeading = document.createElement("span");

          let reportHeadingContainer = document.createElement("div");
          reportHeadingContainer.className = "report-heading";

          let reportCheckbox = document.createElement("input");
          reportCheckbox.type = "checkbox";
          reportCheckbox.checked = window.activeReports[reportID];
          reportCheckbox.value = reportID;
          reportCheckbox.onclick = () => {
            window.activeReports[reportID] = !window.activeReports[reportID];
          };
          let label = document.createElement("label");
          label.setAttribute("for", reportID);
          label.innerText = `Report ${reportID}`;

          reportHeadingContainer.appendChild(reportCheckbox);
          reportHeadingContainer.appendChild(label);

          reportHeading.appendChild(reportHeadingContainer);
          reportHeading.id = "report-heading-" + reportID;

          document
            .getElementById("analyzer-report-headings")
            .appendChild(reportHeading);
        }

        updateByteIndexes(reportBuffer.length);
        for (let i = 0; i < reportBuffer.length; i++) {
          let span = undefined;
          if (previousReportBuffer && i < previousReportBuffer.length) {
            if (
              reportBuffer.readUInt8(i) != previousReportBuffer.readUInt8(i)
            ) {
              span = document.createElement("span");
              span.innerText = hex(reportBuffer.readUInt8(i));
              span.className = "changed";
            } else {
              span = document.createElement("span");
              span.innerText = hex(reportBuffer.readUInt8(i));
              span.className = "notchanged";
            }
          } else {
            span = document.createElement("span");
            span.innerText = hex(reportBuffer.readUInt8(i));
            span.className = "added";
          }

          span.setAttribute("data-reportid", reportID);
          span.setAttribute("data-index", i);

          span.onmousedown = (e) => {
            const clicked = e.target;

            const byteIndex = parseInt(clicked.getAttribute("data-index"));
            const reportID = parseInt(clicked.getAttribute("data-reportid"));
            let watchedBytesForReport = window.watchedBytes[reportID];
            if (!watchedBytesForReport.includes(byteIndex)) {
              clicked.classList.add("highlighted");
            } else {
              clicked.classList.remove("highlighted");
            }
            if (watchedBytesForReport.includes(byteIndex)) {
              window.watchedBytes[reportID] = watchedBytesForReport.filter(
                (x) => x != byteIndex
              );
            } else {
              watchedBytesForReport.push(byteIndex);
            }

            console.log(JSON.stringify(window.watchedBytes));
          };

          if (window.watchedBytes[reportID].includes(i)) {
            span.classList.add("highlighted");
          } else {
            span.classList.remove("highlighted");
          }
          if (i % 2 === 0) {
            span.classList.add("even");
          }
          reportContainer.appendChild(span);
        }

        if (changed === true) {
          const logItem = reportContainer.cloneNode(true);
          document.getElementById("device-log").appendChild(logItem);

          const logItemTime = document.createElement("span");
          logItemTime.innerText =
            (Date.now() - window.start) / 1000 + `s R${reportID}`;
          logItemTime.className = "device-log-id";
          document.getElementById("device-log-ids").appendChild(logItemTime);
        }
      }

      function analyzeDeviceInput(reportID, reportBuffer) {
        console.log("not overridden");
      }

      function clearLog() {
        removeAllChildrenForElement(document.getElementById("scriptOutput"));
      }

      function clearHistory() {
        removeAllChildrenForElement(document.getElementById("device-log-ids"));

        removeAllChildrenForElement(document.getElementById("device-log"));
      }
    </script>
  </head>
  <body>
    <div id="top-bar">
      <span style="margin-left: 12px; font-size: 12px"
        >Changes will be saved when window loses focus / closes</span
      >
      <button class="button" onclick="resetChanges()">Reset Changes</button>
    </div>
    <h5 style="margin: 0; margin-left: 12px">Current Input Data</h5>

    <div id="analyzer-content-container-parent">
      <div id="analyzer-content-container">
        <div id="analyzer-report-headings">
          <span style="font-size: 14px; height: 24px"> Index </span>
        </div>
        <div>
          <div id="analyzer-scroll-container">
            <div id="analyzer-legend"></div>

            <div id="analyzer"></div>
          </div>
          <div id="analyzer-help">
            <span
              >Click the bytes you want to monitor. Your script will only be
              called if one of the monitored bytes changes.</span
            >
          </div>
        </div>
      </div>
    </div>

    <div class="title-flex">
      <h5 style="margin: 0; margin-left: 10px">History Of Monitored Changes</h5>
      <button
        onclick="clearHistory()"
        class="button"
        style="height: fit-content"
      >
        Clear
      </button>
    </div>
    <div id="device-log-container">
      <div id="device-log-ids"></div>
      <div id="device-log"></div>
    </div>

    <div id="script-area">
      <div id="container"></div>
      <div id="script-log-container">
        <div class="title-flex">
          <h5>Script Log (use log() function):</h5>
          <button
            style="height: fit-content"
            class="button"
            onclick="clearLog()"
          >
            Clear
          </button>
        </div>
        <div id="scriptOutput"></div>
      </div>
    </div>
    <script>
      var require = { paths: { vs: "node_modules/monaco-editor/min/vs" } };
    </script>
    <script src="node_modules/monaco-editor/min/vs/loader.js"></script>
    <script src="node_modules/monaco-editor/min/vs/editor/editor.main.nls.js"></script>
    <script src="node_modules/monaco-editor/min/vs/editor/editor.main.js"></script>

    <script>
      const exampleScript = `// Enter your input analyzer script here. 
// Do not change the function signatures
function analyzeDeviceInput(targetDevice, reportID, reportDataHex) {
      
	let reportBuffer = buffer.Buffer.from(reportDataHex, 'hex');
    // the values you see above are in hex format. To read such a byte
    // use readUInt8(index).
    if(reportBuffer.readUInt8(2) === 0x20) {
        log('trigger!');
        bttTriggerDeviceTrigger(targetDevice, 'button6');
    }

    // If you want to get the next report even though,
    // the data has not changed, call this function:
    // bttGetNextEvenWithoutChange(targetDevice, reportID)
}

// Advanced, optional. Use if you want to trigger commands that send data to
// the device, from a BTT predefined action.
// See https://docs.folivora.ai/1500_generic_devices.html
async function executeBTTCommand(targetDevice, commandName, commandInput) {
    log("execute command: " + commandName)
    switch(commandName) {
        case "exampleCommand": {
            // send any hex string to the device
            let deviceResponse = await bttSendDataToDevice({
              BTTActionSendDataTargetDevice: targetDevice,
              BTTActionSendDataData: 'FEEDC0DE',
              BTTActionSendDataReportType: 1,
              BTTActionSendDataResponseType: -1,
              BTTActionSendDataResponsePrefix: ''
            }); 
            break;
        }
    }
    return 'done executing ' + commandName
}`;

      var editor = monaco.editor.create(document.getElementById("container"), {
        value:
          window.script && window.script.length > 0
            ? window.script
            : exampleScript,
        language: "javascript",
        automaticLayout: true,
        minimap: {
          enabled: false,
        },
      });
      if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
        monaco.editor.setTheme("vs-dark");
      }

      window.sourceEditor = editor;
      editor.getModel().onDidChangeContent((event) => {
        try {
          eval.call(window, window.sourceEditor.getValue());
          window.start = Date.now();
          removeAllChildrenForElement(document.getElementById(scriptOutput));
        } catch (e) {
          console.error(e);
        }
      });

      eval.call(window, window.sourceEditor.getValue());
    </script>
  </body>
</html>
